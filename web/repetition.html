<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PerfectPitch — Репетиция</title>
  <style>
    :root { --brand:#3337BC; --muted:#6b7280; }
    body { font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; background:#fff; }
    .topbar { background:var(--brand); color:#fff; padding:16px 24px; font-size:24px; font-weight:800; text-align:center; margin-bottom:16px; }
    .wrap { padding:24px; max-width:1180px; margin:0 auto; }
    h1 { font-size:34px; margin:0 0 10px 0; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .grid { display:grid; grid-template-columns:1.2fr .8fr; gap:24px; }
    .card { border:1px solid #ffffff; border-radius:12px; padding:16px; background:#fff; }
    .stage { border:1px solid #e5e7eb; border-radius:12px; padding:12px; min-height:360px; display:flex; justify-content:center; align-items:center; background:#fff; }
    .stage img { max-width:100%; height:auto; border-radius:8px; border:1px solid #e5e7eb; }
    .muted { color:#6b7280; }
    .btn { cursor:pointer; padding:12px 16px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; display:flex; align-items:center; gap:10px; min-height:56px; font-size:15px; line-height:1.2; text-decoration:none; }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); font-weight:600; }
    .footer { display:flex; justify-content:space-between; align-items:center; margin-top:14px; }
    .btn.disabled { background:#eef2ff; color:#6b7280; border-color:#cbd5e1; cursor:not-allowed; }
    .timer { display:flex; align-items:center; gap:12px; }
    .progress { height:10px; background:#e5e7eb; border-radius:999px; width:380px; position:relative; }
    .progress > span { position:absolute; left:0; top:0; bottom:0; background:#8ba7ff; border-radius:999px; width:0%; }
    .placeholder { background:#e5e7eb; border-radius:10px; height:240px; }
    .metric { border:1px solid #ffffff; border-radius:10px; padding:10px; background:#f8fafc; }
    /* Loading bar */
    .loading { display:none; margin:10px 0 6px 0; }
    .loading .progress { height:6px; width:100%; overflow:hidden; border-radius:999px; }
    .loading .bar { position:relative; display:block; height:6px; background:var(--brand); border-radius:999px; animation: indeterminate 1.2s infinite ease-in-out; left:-40%; width:40%; }
    @keyframes indeterminate { 0% { left:-40%; width:40%; } 50% { left:25%; width:50%; } 100% { left:100%; width:40%; } }
    /* Recommendations styling */
    ul.recs { margin:0; padding-left:18px; }
    ul.recs li.rec { color:#0f172a; background:transparent; border:none; padding:8px 10px; border-radius:0; margin:6px 0; }
  </style>
  <script>
    async function api(path, opts={}) { const r = await fetch(path, opts); if(!r.ok) throw new Error(await r.text()); try { return await r.json(); } catch(_) { return {}; } }
    function getSID(){ const u=new URLSearchParams(location.search).get('sid'); if(u){localStorage.setItem('pp_sid',u);return u;} return localStorage.getItem('pp_sid'); }
    async function ensureSID(){ let s=getSID(); if(!s){ const d=await api('/sessions',{method:'POST'}); s=d.session_id; localStorage.setItem('pp_sid',s);} document.getElementById('sid').textContent=s; return s; }

    // Slides management (reused from slides.html)
    let SLIDES=[], IMGS=[], IDX=0;
    async function loadSlides(){ const sid=getSID(); try { const r=await api(`/slides/${sid}`); SLIDES=r.slides||[]; } catch(_) { SLIDES=[]; } try { const rr=await api(`/slides/${sid}/render`,{method:'POST'}); IMGS=rr.images||[]; } catch(_) { IMGS=[]; } IDX=0; renderSlide(); }
    function renderSlide(){ const img=document.getElementById('img'); const txt=document.getElementById('txt'); const n=document.getElementById('num'); const s=SLIDES[IDX]; if(!s){ txt.textContent='Слайдов нет'; img.style.display='none'; n.textContent='—'; return;} if(IMGS[IDX]){ img.src=IMGS[IDX]; img.style.display='block'; txt.textContent=''; } else { img.style.display='none'; txt.textContent=(s.title||('Slide '+s.index)); } n.textContent=`${s.index} / ${SLIDES.length}`; }
    function prev(){ if(!SLIDES.length) return; IDX=Math.max(0,IDX-1); renderSlide(); }
    function next(){ if(!SLIDES.length) return; IDX=Math.min(SLIDES.length-1,IDX+1); renderSlide(); }

    // Timer based on questions timing
    function getTimingMinutes(){ try { const meta=JSON.parse(localStorage.getItem('pp_meta')||'{}'); return Number(meta.timing_min)||12; } catch(_) { return 12; } }
    let timerTotal=0, timerStart=0, timerId=null, isRecording=false;
    function updateTimerUI(){
      const elapsed = Math.floor((performance.now()-timerStart)/1000);
      const left=document.getElementById('t_elapsed'); const total=document.getElementById('t_total'); const pct=document.getElementById('t_fill');
      const min=Math.floor(elapsed/60); const sec=elapsed%60;
      left.textContent = (min<10?"0":"")+min+":"+(sec<10?"0":"")+sec;
      total.textContent = (timerTotal<10?"0":"")+timerTotal+":00";
      const perc=Math.min(100, (elapsed/(timerTotal*60))*100); pct.style.width=perc+"%";
      if(isRecording && elapsed >= timerTotal*60){ isRecording=false; stopRecording(true); }
    }
    function startTimer(){
      timerTotal=getTimingMinutes();
      timerStart=performance.now();
      // reset UI values
      document.getElementById('t_elapsed').textContent='00:00';
      document.getElementById('t_fill').style.width='0%';
      if(timerId) cancelAnimationFrame(timerId);
      const step=()=>{ updateTimerUI(); if(isRecording){ timerId=requestAnimationFrame(step); } };
      step();
    }
    function stopTimer(){ if(timerId) cancelAnimationFrame(timerId); timerId=null; }

    // Camera and recording
    let mediaStream=null, mediaRec=null;
    async function startRecording(){
      const sid=await ensureSID();
      // Camera removed from layout
      // Immediately update UI and start timer so user sees progress even if mic permission is delayed
      const startBtn=document.getElementById('startBtn'); const stopBtn=document.getElementById('stopBtn');
      startBtn.disabled=true; startBtn.classList.add('disabled'); startBtn.classList.remove('primary');
      stopBtn.disabled=false; stopBtn.classList.add('primary');
      isRecording=true;
      startTimer();

      // Try to start microphone recording; ignore errors to keep flow working visually
      try {
        const astream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRec = new MediaRecorder(astream, { mimeType:'audio/webm;codecs=opus' });
        mediaRec.ondataavailable = async (e)=>{ if(e.data && e.data.size>0){ const fd=new FormData(); fd.append('chunk', e.data, 'chunk.webm'); await fetch(`/audio/${sid}/chunk`,{method:'POST', body:fd}); } };
        mediaRec.start(1000);
      } catch (e) {
        console.error(e);
      }
    }
    async function stopRecording(auto=false){ const sid=getSID(); if(!mediaRec){ isRecording=false; stopTimer(); if(auto){ try { const resp = await fetch(`/process/${sid}`, { method:'POST' }); const data = await resp.json().catch(()=>({})); if (resp.ok && data && data.task_id){ localStorage.setItem('pp_task', data.task_id); } } catch(_) {} goNext(); } return; } await new Promise(r=>{ mediaRec.onstop=r; mediaRec.stop(); }); await fetch(`/audio/${sid}/finalize`,{method:'POST'}); const startBtn=document.getElementById('startBtn'); const stopBtn=document.getElementById('stopBtn'); startBtn.disabled=false; startBtn.classList.remove('disabled'); startBtn.classList.add('primary'); stopBtn.disabled=true; stopBtn.classList.remove('primary'); stopTimer(); isRecording=false; if(auto){ try { const resp = await fetch(`/process/${sid}`, { method:'POST' }); const data = await resp.json().catch(()=>({})); if (resp.ok && data && data.task_id){ localStorage.setItem('pp_task', data.task_id); } } catch(_) {} goNext(); return; } showStats(); try { const resp = await fetch(`/process/${sid}`, { method:'POST' }); const data = await resp.json().catch(()=>({})); if (resp.ok && data && data.task_id){ localStorage.setItem('pp_task', data.task_id); } } catch(_) {} }

    function resetRepetition(){
      try { localStorage.removeItem('pp_task'); } catch(_){ }
      const stats=document.getElementById('stats'); if(stats) stats.style.display='none';
      const startBtn=document.getElementById('startBtn'); const stopBtn=document.getElementById('stopBtn');
      if(startBtn){ startBtn.disabled=false; startBtn.classList.remove('disabled'); startBtn.classList.add('primary'); }
      if(stopBtn){ stopBtn.disabled=true; stopBtn.classList.remove('primary'); }
      isRecording=false; stopTimer();
      const elapsed=document.getElementById('t_elapsed'); const fill=document.getElementById('t_fill');
      if(elapsed) elapsed.textContent='00:00';
      if(fill) fill.style.width='0%';
      try { const rb=document.getElementById('repeatBtn'); if (rb) rb.style.display='none'; } catch(_) {}
      try { window.scrollTo({top:0, behavior:'smooth'}); } catch(_) {}
    }

    function showLoading(msg){ const l=document.getElementById('loading'); const t=document.getElementById('loading_text'); if(t && msg) t.textContent=msg; if(l) l.style.display='block'; }
    function hideLoading(){ const l=document.getElementById('loading'); if(l) l.style.display='none'; }

    async function showStats(){
      document.getElementById('stats').style.display='grid';
      const sid=getSID();
      showLoading('Считаем метрики речи…');
      // Wait for background task if present
      const taskId = localStorage.getItem('pp_task');
      if (taskId) {
        const t0 = Date.now();
        const limitMs = 120000;
        while (Date.now() - t0 < limitMs) {
          try {
            const s = await fetch(`/status/${taskId}`).then(r=>r.json());
            if (s && (s.state === 'DONE' || s.state === 'FAILED')) break;
          } catch(_) {}
          await new Promise(r=>setTimeout(r, 1200));
        }
      }
      try {
        const rep = await fetch(`/artifacts/${sid}/report.json`, { cache: 'no-store' }).then(r=>r.json());
        const sp = rep && rep.speech_quality ? rep.speech_quality : null;
        if (sp && sp.available){
          const box = document.getElementById('speech_metrics');
          if (box){
            const pauses = sp.pauses||{};
            box.innerHTML = `
              <div class="metric"><strong>WPM</strong>: ${sp.wpm}</div>
              <div class="metric" style="margin-top:6px"><strong>Паузы</strong>: count ${pauses.count||0}, avg ${pauses.avg_ms||0}мс, p90 ${pauses.p90_ms||0}мс</div>
            `;
          }
        }
        // Load deck recommendations from feedback.md
        try {
          const resp = await fetch(`/artifacts/${sid}/feedback.md`, { cache: 'no-store' });
          if (resp.ok) {
            const text = await resp.text();
            const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.startsWith('-'));
            const html = lines.map(s=>`<li class="rec">${escapeHtml(s.replace(/^[-\s]+/, ''))}</li>`).join('') || '<li class="muted">—</li>';
            const list = document.getElementById('deck_recs');
            if (list) list.innerHTML = html;
          }
        } catch(_) {}
      } catch(_){ }
      try {
        const rb=document.getElementById('repeatBtn');
        if (rb) {
          const list = document.getElementById('deck_recs');
          const hasRec = !!(list && list.querySelector('li.rec'));
          rb.style.display = hasRec ? 'inline-flex' : 'none';
        }
      } catch(_) {}
      hideLoading();
    }

    function escapeHtml(s){ return (String(s||'')).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function goBack(){ const sid=getSID(); location.href='/ui/slides.html' + (sid?('?sid='+encodeURIComponent(sid)):''); }
    function goNext(){ const sid=getSID(); location.href='/ui/response.html' + (sid?('?sid='+encodeURIComponent(sid)):''); }

    document.addEventListener('DOMContentLoaded', async ()=>{ await ensureSID(); await loadSlides(); document.getElementById('t_total').textContent=(getTimingMinutes()<10?"0":"")+getTimingMinutes()+":00"; });
  </script>
</head>
<body>
  <div class="topbar">PerfectPitch</div>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>Репетиция</h1>
      <div class="progress-counter">4/5</div>
    </div>

    <div class="row timer" style="margin:8px 0 16px 0;">
      <div class="muted" id="t_elapsed">00:00</div>
      <div class="progress"><span id="t_fill"></span></div>
      <div class="muted" id="t_total">12:00</div>
    </div>

    <div class="grid">
      <div id="loading" class="loading" style="grid-column: 1 / -1;">
        <div class="progress"><span class="bar"></span></div>
        <div class="muted" id="loading_text">Считаем метрики речи…</div>
      </div>
      <div class="card">
        <div class="stage">
          <img id="img" alt="slide" />
          <div id="txt" class="muted"></div>
          
        </div>
        <div class="row" style="margin-top:10px; justify-content:center; gap:18px;">
          <button class="btn" onclick="prev()">&lt;</button>
          <span id="num" class="muted">—</span>
          <button class="btn" onclick="next()">&gt;</button>
        </div>
      </div>
      <div class="card">
        <div class="row" style="margin-top:12px; justify-content:flex-start; gap:12px;">
          <button id="startBtn" class="btn primary" onclick="startRecording()">Начать выступление</button>
          <button id="stopBtn" class="btn" disabled onclick="stopRecording()">Закончить выступление</button>
          <button id="repeatBtn" class="btn" style="display:none" onclick="resetRepetition()">↻ Повторить с рекомендациями</button>
        </div>
      </div>
    </div>

    <!-- Post-recording stats placeholder (image 2 layout) -->
    <div id="stats" class="grid" style="display:none; margin-top:16px; grid-template-columns:1fr 1fr; gap:24px;">
      <div class="card">
        <div style="text-align:center; font-weight:600; margin-bottom:8px">Речь — ключевые метрики</div>
        <div id="speech_metrics"></div>
      </div>
      <div class="card">
        <div style="text-align:center; font-weight:600; margin-bottom:8px">Рекомендации</div>
        <ul id="deck_recs" class="recs"></ul>
      </div>
    </div>

    <div class="footer">
      <button class="btn" onclick="goBack()">← Назад</button>
      <div class="muted">session_id: <code id="sid">—</code></div>
      <button class="btn primary" onclick="goNext()">Далее →</button>
    </div>
  </div>
</body>
</html>


