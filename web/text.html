<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PerfectPitch — Анализ текста</title>
  <style>
    :root { --brand:#3337BC; --muted:#6b7280; }
    html, body { height:100%; }
    body { font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; min-height:100vh; }
    .topbar { background:var(--brand); color:#fff; padding:16px 24px; font-size:24px; font-weight:800; text-align:center; margin-bottom:16px; }
    .wrap { padding:24px; max-width:1200px; margin:0 auto; min-height:calc(100vh - 80px); display:flex; flex-direction:column; }
    h1 { font-size:34px; margin:0 0 10px 0; }
    .grid { flex:1; display:grid; grid-template-columns:1fr 1fr; gap:36px; align-items:start; }
    .drop { border:2px dashed #cbd5e1; border-radius:12px; height:92px; display:flex; align-items:center; justify-content:center; color:#9aa3af; }
    textarea { width:100%; height:360px; border:1px solid #cbd5e1; border-radius:12px; padding:12px; resize:vertical; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .muted { color:#6b7280; font-size:12px; }
    .row { display:flex; align-items:center; gap:12px; }
    .btn { cursor:pointer; padding:12px 16px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; display:flex; align-items:center; gap:10px; min-height:56px; font-size:15px; line-height:1.2; text-decoration:none; }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .footer { display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:10px; }
    .footer .btn, .footer .btn.primary { font-size:16px; font-weight:600; }
    /* Loading bar */
    .loading { display:none; margin-bottom:10px; }
    .progress { position:relative; height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress .bar { position:absolute; left:-40%; top:0; bottom:0; width:40%; background:var(--brand); border-radius:999px; animation: indeterminate 1.2s infinite ease-in-out; }
    @keyframes indeterminate { 0% { left:-40%; width:40%; } 50% { left:25%; width:50%; } 100% { left:100%; width:40%; } }
    .hidden { display:none; }
    /* Align right analysis card with textarea top */
    #right-pane { margin-top:32px; }
    .progress-counter { font-size:16px; font-weight:600; color:var(--muted); }
    .score { width:92px; height:92px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; color:#1a5f1a; position:relative; }
    .score svg { width:92px; height:92px; transform:rotate(-90deg); }
    .score .label { position:absolute; font-size:18px; font-weight:700; }
  </style>
  <script>
    async function api(path, opts={}) {
      const res = await fetch(path, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
    }

    function getSID() {
      const urlSid = new URLSearchParams(location.search).get('sid');
      if (urlSid) { localStorage.setItem('pp_sid', urlSid); return urlSid; }
      return localStorage.getItem('pp_sid');
    }

    async function ensureSID() {
      let sid = getSID();
      if (!sid) { const d = await api('/sessions', {method:'POST'}); sid = d.session_id; localStorage.setItem('pp_sid', sid); }
      document.getElementById('sid').textContent = sid;
      return sid;
    }

    async function uploadText() {
      const sid = await ensureSID();
      const txt = (document.getElementById('text').value || '').slice(0, 1500);
      // show loading bar
      try { document.getElementById('loading').style.display = 'block'; } catch(_) {}
      const blob = new Blob([txt], {type:'text/plain; charset=utf-8'});
      const fd = new FormData(); fd.append('file', blob, 'script.txt');
      await api(`/uploads/${sid}`, {method:'POST', body: fd});
      document.getElementById('right-pane').classList.remove('hidden');
      await analyze();
      try { document.getElementById('loading').style.display = 'none'; } catch(_) {}
    }

    // file upload removed; only manual text input is supported

    function goNext() {
      const sid = getSID();
      location.href = '/ui/slides.html' + (sid ? ('?sid=' + encodeURIComponent(sid)) : '');
    }

    function renderScoreCircle(pct){
      pct = Math.max(0, Math.min(100, Number(pct)||0));
      const r = 40; // radius
      const c = 2 * Math.PI * r; // circumference
      const dash = (pct / 100) * c;
      const rest = c - dash;
      const el = document.getElementById('score');
      if (!el) return;
      const color = pct >= 70 ? '#22c55e' : (pct >= 40 ? '#f59e0b' : '#ef4444');
      el.innerHTML = `
        <svg viewBox="0 0 100 100" aria-label="${pct}%">
          <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="10" fill="none" />
          <circle cx="50" cy="50" r="40" stroke="${color}" stroke-width="10" fill="none"
                  stroke-dasharray="${dash} ${rest}" stroke-linecap="round" />
        </svg>
        <div class="label">${pct}%</div>
      `;
      el.style.color = color;
    }

    async function analyze(){
      const sid = await ensureSID();
      try {
        const res = await api(`/text/${sid}/analyze`, { method:'POST' });
        const score = Number(res.score_0_100 || 0);
        renderScoreCircle(score);
        const recs = Array.isArray(res.recommendations) ? res.recommendations : [];
        const thesis = Array.isArray(res.thesis) ? res.thesis : [];
        const rbox = document.getElementById('recs');
        if (rbox) { rbox.innerHTML = recs.map(x=>`<li>${escapeHtml(String(x))}</li>`).join('') || '<li class="muted">—</li>'; }
        const tbox = document.getElementById('thesis');
        if (tbox) { tbox.innerHTML = thesis.map(x=>`<li>${escapeHtml(String(x))}</li>`).join('') || '<li class="muted">—</li>'; }
      } catch (e) {
        try { console.error(e); } catch(_) {}
      }
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
  </script>
</head>
<body>
  <div class="topbar">PerfectPitch</div>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; margin-bottom:24px;">
      <h1>Анализ текста</h1>
      <div class="progress-counter">2/5</div>
    </div>
    <div class="grid">
      <div>
        <div id="loading" class="loading">
          <div class="progress"><span class="bar"></span></div>
        </div>
        <div style="margin-bottom:10px; color:#0f172a; font-size:16px; font-weight:600">Введите текст для выступления ниже</div>
        <textarea id="text" placeholder="Введите или вставьте текст (до 1500 символов)"></textarea>
        <div class="muted">Ограничение: 1500 символов</div>
        <div style="height:8px"></div>
        <button class="btn primary" style="padding:14px 22px; border-radius:12px; font-size:17px; font-weight:600" onclick="uploadText()">Проверить</button>
      </div>
      <div id="right-pane" class="card hidden">
        <div class="row" style="gap:14px; align-items:center;">
          <div id="score" class="score"><div class="label">0%</div></div>
          <div class="muted">качество текста</div>
        </div>
        <div style="height:12px"></div>
        <div><strong>Рекомендации</strong></div>
        <ul id="recs" class="muted" style="margin-top:6px">
          <li>—</li>
        </ul>
        <div style="height:12px"></div>
        <div><strong>Тезисы</strong></div>
        <ul id="thesis" class="muted" style="margin-top:6px">
          <li>—</li>
        </ul>
      </div>
    </div>

    <div class="footer">
      <a class="btn" href="/ui/questions.html">← Назад</a>
      <div class="muted">session_id: <code id="sid">—</code></div>
      <button class="btn primary" onclick="goNext()">Далее →</button>
    </div>
  </div>

  <script>ensureSID();</script>
</body>
</html>


