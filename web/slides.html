<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PerfectPitch — Слайды</title>
  <style>
    :root { --brand:#3340d9; --muted:#6b7280; }
    body { font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; }
    .topbar { background:#3340d9; color:#fff; padding:16px 24px; font-size:24px; font-weight:800; text-align:center; margin-bottom:16px; }
    .wrap { padding:24px; max-width:1180px; margin:0 auto; }
    h1 { font-size:34px; margin:0 0 10px 0; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { cursor:pointer; padding:10px 14px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; }
    .btn.primary { background:#3340d9; color:#fff; border-color:#2a32b8; }
    .muted { color:#6b7280; }
    .stage { border:1px solid #e5e7eb; border-radius:12px; padding:12px; min-height:360px; display:flex; justify-content:center; align-items:center; background:#fff; }
    .stage img { max-width:100%; height:auto; border-radius:8px; border:1px solid #e5e7eb; }
    .grid { display:grid; grid-template-columns:1.2fr .8fr; gap:24px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .drop { border:2px dashed #cbd5e1; border-radius:12px; height:240px; display:flex; align-items:center; justify-content:center; color:#9aa3af; }
    .right-box { border:1px solid #e5e7eb; border-radius:12px; padding:12px; min-height:360px; background:#f4f5f7; }
    .space-between { display:flex; justify-content:space-between; align-items:center; }
  </style>
  <script>
    async function api(path, opts={}) { const r = await fetch(path, opts); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function getSID(){ const u=new URLSearchParams(location.search).get('sid'); if(u){localStorage.setItem('pp_sid',u);return u;} return localStorage.getItem('pp_sid'); }
    async function ensureSID(){ let s=getSID(); if(!s){ const d=await api('/sessions',{method:'POST'}); s=d.session_id; localStorage.setItem('pp_sid',s);} document.getElementById('sid').textContent=s; return s; }

    let SLIDES=[], IMGS=[], IDX=0;
    function resetStart(){ SLIDES=[]; IMGS=[]; IDX=0; document.getElementById('start').style.display='block'; document.getElementById('viewer').style.display='none'; document.getElementById('deck').value=''; }

    async function uploadDeck(){ const sid=await ensureSID(); const f=document.getElementById('deck').files[0]; if(!f) return; const fd=new FormData(); fd.append('file', f, 'pptx.pptx'); await fetch(`/uploads/${sid}`,{method:'POST', body: fd}); await loadSlides(); await renderImages(); document.getElementById('start').style.display='none'; document.getElementById('viewer').style.display='block'; }
    async function loadSlides(){ const sid=getSID(); const r=await api(`/slides/${sid}`); SLIDES=r.slides||[]; IDX=0; render(); }
    async function renderImages(){ const sid=getSID(); const r=await api(`/slides/${sid}/render`,{method:'POST'}); IMGS=r.images||[]; render(); }
    function render(){ const img=document.getElementById('img'); const txt=document.getElementById('txt'); const n=document.getElementById('num'); const s=SLIDES[IDX]; if(!s){ txt.textContent='Слайдов нет'; img.style.display='none'; n.textContent='—'; return;} if(IMGS[IDX]){ img.src=IMGS[IDX]; img.style.display='block'; txt.textContent=''; } else { img.style.display='none'; txt.textContent=(s.title||('Slide '+s.index)); } n.textContent=`${s.index} / ${SLIDES.length}`; }
    function prev(){ if(!SLIDES.length) return; IDX=Math.max(0,IDX-1); render(); }
    function next(){ if(!SLIDES.length) return; IDX=Math.min(SLIDES.length-1,IDX+1); render(); }

    function goBack(){ const sid=getSID(); location.href='/ui/text.html' + (sid?('?sid='+encodeURIComponent(sid)):''); }
    function goNext(){ const sid=getSID(); location.href='/ui/repetition.html' + (sid?('?sid='+encodeURIComponent(sid)):''); }
  </script>
</head>
<body>
  <div class="topbar">PerfectPitch</div>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>Анализ слайдов</h1>
      <div class="muted">3/5</div>
    </div>

    <!-- Start (initial) state -->
    <div id="start" class="card">
      <div class="row" style="justify-content:center; margin-bottom:12px; color:#111827; font-weight:500;">Загрузите презентацию в формате pptx</div>
      <label class="drop" for="deck">Перетащите файл сюда или выберите</label>
      <input id="deck" type="file" accept=".pptx,.pptm" style="display:none" />
      <div class="row" style="justify-content:center; margin-top:18px;">
        <button class="btn primary" onclick="uploadDeck()">Проверить</button>
      </div>
    </div>

    <!-- Viewer state -->
    <div id="viewer" class="grid" style="display:none">
      <div class="card">
        <div class="space-between" style="margin-bottom:6px">
          <div style="font-weight:700">Слайды</div>
          <button class="btn" onclick="resetStart()">↻ загрузить другую презентацию</button>
        </div>
        <div class="stage">
          <img id="img" alt="slide" />
          <div id="txt" class="muted"></div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:center; gap:18px;">
          <button class="btn" onclick="prev()">&lt;</button>
          <span id="num" class="muted">—</span>
          <button class="btn" onclick="next()">&gt;</button>
        </div>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:8px">Рекомендации</div>
        <div class="right-box"></div>
        <div class="row" style="margin-top:12px; justify-content:flex-start;">
          <button class="btn">Применить рекомендации</button>
        </div>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:14px;">
      <button class="btn" onclick="goBack()">← Назад</button>
      <div class="muted">session_id: <code id="sid">—</code></div>
      <button class="btn primary" onclick="goNext()">Далее →</button>
    </div>
  </div>
  <script>ensureSID();</script>
</body>
</html>


