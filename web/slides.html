<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PerfectPitch — Слайды</title>
  <style>
    :root { --brand:#3337BC; --muted:#6b7280; }
    body { font-family:-apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; }
    .topbar { background:var(--brand); color:#fff; padding:16px 24px; font-size:24px; font-weight:800; text-align:center; margin-bottom:16px; }
    .wrap { padding:24px; max-width:1180px; margin:0 auto; }
    h1 { font-size:34px; margin:0 0 10px 0; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { cursor:pointer; padding:12px 16px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; display:flex; align-items:center; gap:10px; min-height:56px; font-size:15px; line-height:1.2; text-decoration:none; }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); font-weight:600; }
    .muted { color:#6b7280; }
    .stage { border:1px solid #e5e7eb; border-radius:12px; padding:12px; min-height:360px; display:flex; justify-content:center; align-items:center; background:#fff; }
    .stage img { max-width:100%; height:auto; border-radius:8px; border:1px solid #e5e7eb; }
    .grid { display:grid; grid-template-columns:1.2fr .8fr; gap:24px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .drop { border:2px dashed #cbd5e1; border-radius:12px; height:360px; display:flex; align-items:center; justify-content:center; color:#9aa3af; }
    .right-box { border:1px solid #e5e7eb; border-radius:12px; padding:12px; min-height:360px; background:#ffffff; }
    .space-between { display:flex; justify-content:space-between; align-items:center; }
    ul.recs { margin:0; padding-left:18px; }
    ul.recs li.rec { color:#0f172a; background:transparent; border:none; padding:10px 12px; border-radius:0; margin:12px 0; }
    /* Loading bar */
    .loading { display:none; margin:10px 0 6px 0; }
    .progress { position:relative; height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress .bar { position:absolute; left:-40%; top:0; bottom:0; width:40%; background:var(--brand); border-radius:999px; animation: indeterminate 1.2s infinite ease-in-out; }
    @keyframes indeterminate { 0% { left:-40%; width:40%; } 50% { left:25%; width:50%; } 100% { left:100%; width:40%; } }
    .hidden { display:none; }
  </style>
  <script>
    async function api(path, opts={}) { const r = await fetch(path, opts); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function getSID(){ const u=new URLSearchParams(location.search).get('sid'); if(u){localStorage.setItem('pp_sid',u);return u;} return localStorage.getItem('pp_sid'); }
    async function ensureSID(){ let s=getSID(); if(!s){ const d=await api('/sessions',{method:'POST'}); s=d.session_id; localStorage.setItem('pp_sid',s);} document.getElementById('sid').textContent=s; return s; }

    let SLIDES=[], IMGS=[], IDX=0, METRICS=null;
    let PRE_UPLOAD = { done:false, name:null };
    function resetStart(){
      SLIDES=[]; IMGS=[]; IDX=0; METRICS=null;
      const num=document.getElementById('num'); if(num) num.textContent='—';
      const img=document.getElementById('img'); if(img){ img.src=''; img.style.display='none'; }
      const txt=document.getElementById('txt'); if(txt){ txt.textContent='Слайдов нет'; }
      const inp=document.getElementById('deck'); if(inp){ inp.value=''; }
      const us=document.getElementById('upload_status'); if(us){ us.textContent=''; }
      PRE_UPLOAD={done:false, name:null};
      const leftStart=document.getElementById('left-start');
      const leftSlides=document.getElementById('left-slides');
      const right=document.getElementById('right-card');
      if(leftStart) leftStart.classList.remove('hidden');
      if(leftSlides) leftSlides.classList.add('hidden');
      if(right) right.classList.add('hidden');
    }

    function showLoading(msg){ const l=document.getElementById('loading'); const t=document.getElementById('loading_text'); if(t && msg) t.textContent=msg; if(l) l.style.display='block'; }
    function hideLoading(){ const l=document.getElementById('loading'); if(l) l.style.display='none'; }

    async function uploadDeck(){
      let sid=await ensureSID();
      const fileEl=document.getElementById('deck');
      const f=fileEl && fileEl.files[0];
      if(!f) return;
      const fd=new FormData(); fd.append('file', f, 'pptx.pptx');
      showLoading('Загружаем и рендерим слайды…');
      try {
        if (!(PRE_UPLOAD.done && PRE_UPLOAD.name === f.name)) {
          const res = await fetch(`/uploads/${sid}`, { method:'POST', body: fd });
          if (res.status === 404) {
            localStorage.removeItem('pp_sid');
            const d = await api('/sessions', { method:'POST' });
            sid = d.session_id;
            localStorage.setItem('pp_sid', sid);
            const retry = await fetch(`/uploads/${sid}`, { method:'POST', body: fd });
            if (!retry.ok) throw new Error(await retry.text());
          } else if (!res.ok) {
            throw new Error(await res.text());
          }
        }
        await loadSlides();
        await renderImages();
        await requestReview();
        const leftStart=document.getElementById('left-start');
        const leftSlides=document.getElementById('left-slides');
        const right=document.getElementById('right-card');
        if(leftStart) leftStart.classList.add('hidden');
        if(leftSlides) leftSlides.classList.remove('hidden');
        if(right) right.classList.remove('hidden');
      } catch (e) {
        alert('Ошибка загрузки презентации: ' + (e?.message || e));
      } finally {
        hideLoading();
      }
    }

    async function onDeckSelected(){
      const fileEl=document.getElementById('deck');
      const f=fileEl && fileEl.files[0];
      const us=document.getElementById('upload_status');
      if(!f){ if(us) us.textContent=''; PRE_UPLOAD={done:false, name:null}; return; }
      let sid = await ensureSID();
      const fd=new FormData(); fd.append('file', f, 'pptx.pptx');
      try {
        showLoading('Загружаем презентацию…');
        const res = await fetch(`/uploads/${sid}`, { method:'POST', body: fd });
        if (res.status === 404) {
          localStorage.removeItem('pp_sid');
          const d = await api('/sessions', { method:'POST' });
          sid = d.session_id;
          localStorage.setItem('pp_sid', sid);
          const retry = await fetch(`/uploads/${sid}`, { method:'POST', body: fd });
          if (!retry.ok) throw new Error(await retry.text());
        } else if (!res.ok) {
          throw new Error(await res.text());
        }
        PRE_UPLOAD = { done:true, name:f.name };
        if(us) us.textContent = `«${f.name}» был загружен`;
      } catch(e){
        PRE_UPLOAD = { done:false, name:null };
        if(us) us.textContent = '';
        alert('Ошибка загрузки файла: ' + (e?.message || e));
      } finally {
        hideLoading();
      }
    }
    async function loadSlides(){ const sid=getSID(); const r=await api(`/slides/${sid}`); SLIDES=r.slides||[]; METRICS=r.metrics||null; IDX=0; render(); renderMetrics(); }
    async function renderImages(){ const sid=getSID(); const r=await api(`/slides/${sid}/render`,{method:'POST'}); IMGS=r.images||[]; render(); }
    function render(){ const img=document.getElementById('img'); const txt=document.getElementById('txt'); const n=document.getElementById('num'); const s=SLIDES[IDX]; if(!s){ txt.textContent='Слайдов нет'; img.style.display='none'; n.textContent='—'; renderMetrics(); return;} if(IMGS[IDX]){ img.src=IMGS[IDX]; img.style.display='block'; txt.textContent=''; } else { img.style.display='none'; txt.textContent=(s.title||('Slide '+s.index)); } n.textContent=`${s.index} / ${SLIDES.length}`; renderMetrics(); }

    async function requestReview(){ const sid=getSID(); try { const r = await api(`/slides/${sid}/review`, { method:'POST' }); window.DECK_REVIEW = r; } catch(_) { window.DECK_REVIEW = null; } renderMetrics(); }

    function renderMetrics(){
      const box = document.querySelector('.right-box');
      if(!box){ return; }
      try{
        const rv = window.DECK_REVIEW;
        const cur = SLIDES[IDX];
        const curIndex = cur ? Number(cur.index) : null;
        if (rv && Array.isArray(rv.per_slide) && curIndex!=null){
          const item = rv.per_slide.find(x=>Number(x.index)===curIndex);
          if (item){
            const arr = Array.isArray(item.recommendations) ? item.recommendations : [];
            if (arr.length) {
              const recs = arr.map(x=>`<li class=\"rec\">${escapeHtml(String(x))}</li>`).join('');
              box.innerHTML = `<div style=\"font-weight:800; font-size:20px; margin-bottom:20px\">Рекомендации для слайда ${curIndex}</div><ul class=\"recs\">${recs}</ul>`;
            } else {
              box.innerHTML = `<div style=\"font-weight:800; font-size:20px; margin-bottom:20px\">Рекомендации для слайда ${curIndex}</div><div class=\"muted\">Это хороший слайд!</div>`;
            }
            return;
          }
        }
      } catch(_){ }
      // fallback to metric-based heuristics
      if(!METRICS){ box.innerHTML = '<div class="muted">Метрики недоступны</div>'; return; }
      try{
        const cur = SLIDES[IDX];
        const curIndex = cur ? Number(cur.index) : null;
        const densBad = METRICS.text_density?.bad_on || [];
        const small = METRICS.small_fonts || [];
        const contrast = METRICS.contrast_issues || [];
        const style = METRICS.style_inconsistency || [];
        const recs = [];
        if (curIndex!=null){
          if (densBad.includes(curIndex)) recs.push('Слайд перегружен текстом — сократите и упрощайте.');
          if (small.includes(curIndex)) recs.push('Увеличьте минимальный кегль шрифта до 18pt+.');
          if (contrast.includes(curIndex)) recs.push('Улучшите контраст текста и фона для читаемости.');
          if (style.includes(curIndex)) recs.push('Приведите стили к единому виду (шрифт/размер).');
        }
        if(recs.length){
          const items = recs.map(x=>`<li class=\"rec\">${escapeHtml(String(x))}</li>`).join('');
          box.innerHTML = `<div style=\"font-weight:800; font-size:20px; margin-bottom:20px\">Рекомендации для текущего слайда</div><ul class=\"recs\">${items}</ul>`;
        } else {
          box.innerHTML = `<div style=\"font-weight:800; font-size:20px; margin-bottom:20px\">Рекомендации для текущего слайда</div><div class=\"muted\">Это хороший слайд!</div>`;
        }
      } catch(_){ box.innerHTML = '<div class="muted">Метрики недоступны</div>'; }
    }
    function escapeHtml(s){ return (String(s||'')).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function prev(){ if(!SLIDES.length) return; IDX=Math.max(0,IDX-1); render(); }
    function next(){ if(!SLIDES.length) return; IDX=Math.min(SLIDES.length-1,IDX+1); render(); }

    function goBack(){ const sid=getSID(); location.href='/ui/text.html' + (sid?('?sid='+encodeURIComponent(sid)):''); }
    function goNext(){ const sid=getSID(); location.href='/ui/repetition.html' + (sid?('?sid='+encodeURIComponent(sid)):''); }
  </script>
</head>
<body>
  <div class="topbar">PerfectPitch</div>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>Анализ слайдов</h1>
      <div class="progress-counter">3/5</div>
    </div>

    <div id="loading" class="loading">
      <div class="progress"><span class="bar"></span></div>
      <div class="muted" id="loading_text">Рендерим слайды…</div>
    </div>

    <!-- Main two-column grid -->
    <div id="viewer" class="grid" style="display:grid">
      <div>
        <!-- Left column: upload before, slides after -->
        <div id="left-start" class="card" style="border-color: #ffffff;">
          <div class="row" style="margin-bottom:12px; color:#111827; font-weight:500;">Загрузите презентацию в формате .pptx</div>
          <label class="drop" for="deck">Перетащите файл сюда или выберите</label>
          <input id="deck" type="file" accept=".pptx,.pptm" style="display:none" />
          <div class="muted" id="upload_status" style="margin-top:8px"></div>
          <div class="row" style="margin-top:18px;">
            <button class="btn primary" onclick="uploadDeck()">Проверить</button>
          </div>
        </div>

        <div id="left-slides" class="card hidden" style="border-color: #ffffff;">
        <div class="space-between" style="margin-bottom:10px">
          <div style="font-weight:800; font-size:20px">Слайды</div>
          <button class="btn" onclick="resetStart()">↻ загрузить другую презентацию</button>
        </div>
        <div class="stage">
          <img id="img" alt="slide" />
          <div id="txt" class="muted"></div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:center; gap:18px;">
          <button class="btn" onclick="prev()">&lt;</button>
          <span id="num" class="muted">—</span>
          <button class="btn" onclick="next()">&gt;</button>
        </div>
        </div>
      </div>
      <div id="right-card" class="card hidden" style="border-color:#ffffff">
        <div class="right-box" style="border-color:#ffffff"></div>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:14px;">
      <button class="btn" onclick="goBack()">← Назад</button>
      <div class="muted">session_id: <code id="sid">—</code></div>
      <button class="btn primary" onclick="goNext()">Далее →</button>
    </div>
  </div>
  <script>
    ensureSID();
    document.addEventListener('DOMContentLoaded', ()=>{
      const deck = document.getElementById('deck');
      if (deck) deck.addEventListener('change', onDeckSelected);
    });
  </script>
</body>
</html>


